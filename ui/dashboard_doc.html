<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard | CodeBuddies Health</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #16a085;
            --bg: #f0fdfa;
            --dark: #2c3e50;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); height: 100vh; overflow: hidden; }
        
        /* Sidebar Styles */
        .sidebar {
            background: white; border-right: 1px solid #e2e8f0; height: 100vh; overflow-y: auto;
        }
        .patient-card {
            cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; padding: 15px; border-bottom: 1px solid #f1f5f9;
        }
        .patient-card:hover { background: #f8fafc; }
        .patient-card.active { background: #e0f2f1; border-left-color: var(--primary); }
        .patient-card.critical { border-left-color: #dc3545 !important; background: #fff5f5; }
        .patient-card.normal { border-left-color: #198754 !important; }

        /* Main Content */
        .main-content { height: 100vh; overflow-y: auto; padding: 30px; display: none; } /* Hidden by default */
        .empty-state { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #94a3b8; }
        
        .report-img { max-height: 400px; width: 100%; object-fit: contain; background: #000; border-radius: 10px; }
        
        .btn-primary { background-color: var(--primary); border-color: var(--primary); }
        .btn-primary:hover { background-color: #1abc9c; border-color: #1abc9c; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        
        <div class="col-md-3 col-lg-2 sidebar p-0">
            <div class="p-3 border-bottom bg-white sticky-top">
                <h5 class="fw-bold text-primary m-0">üë®‚Äç‚öïÔ∏è Doctor Panel</h5>
                <small class="text-muted">CodeBuddies Health</small>
            </div>
            
            <div id="patientList">
                <div class="text-center p-3 text-muted">Loading patients...</div>
            </div>
        </div>

        <div class="col-md-9 col-lg-10 p-0">
            
            <div id="emptyState" class="empty-state">
                <h1 style="font-size: 4rem;">ü©∫</h1>
                <h3>Select a patient to review</h3>
                <p>Click on the sidebar to load a medical report.</p>
            </div>

            <div id="mainContent" class="main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold text-dark mb-0" id="pName">Patient Name</h2>
                        <span class="text-muted" id="pDetails">ID: #0 | Age: 0</span>
                    </div>
                    <div>
                        <a id="dietLink" href="#" target="_blank" class="btn btn-outline-primary btn-sm">
                            ü•ó View Diet Plan
                        </a>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card shadow-sm border-0 mb-3">
                            <div class="card-header bg-white fw-bold">üì∏ Original Scan</div>
                            <div class="card-body p-0 text-center bg-light">
                                <a id="imgLink" href="#" target="_blank">
                                    <img id="scanImg" src="" class="report-img" alt="Scan">
                                </a>
                            </div>
                        </div>

                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white fw-bold text-primary">ü§ñ AI Analysis</div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; background: #f8f9fa;">
                                <pre id="aiResult" style="white-space: pre-wrap; font-family: inherit; font-size: 0.9rem; color: #444;"></pre>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-header bg-primary text-white fw-bold">
                                üë®‚Äç‚öïÔ∏è Official Diagnosis & Notes
                            </div>
                            <div class="card-body d-flex flex-column">
                                <form id="diagnosisForm" class="h-100 d-flex flex-column">
                                    <input type="hidden" id="reportId" name="report_id">
                                    
                                    <div class="mb-3 flex-grow-1">
                                        <label class="form-label text-muted small fw-bold">WRITE YOUR OPINION:</label>
                                        <textarea id="docOpinion" name="doctor_opinion" class="form-control h-100" style="resize: none; background: #fffbe6;" placeholder="Doctor's clinical notes override AI suggestions..."></textarea>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary py-3 fw-bold">
                                            ‚úÖ Approve & Save Diagnosis
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 1. LOAD PATIENT LIST ON START ---
    document.addEventListener("DOMContentLoaded", () => {
        loadPatients();
    });

    function loadPatients() {
      fetch('../api/dashboard_doc.php?action=list')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('patientList');
                list.innerHTML = '';
                
                if(data.length === 0) {
                    list.innerHTML = '<div class="p-3 text-center text-muted">No patients found.</div>';
                    return;
                }

                data.forEach(p => {
                    const severityClass = p.is_critical ? 'critical' : 'normal';
                    const statusBadge = p.doc_status === 'reviewed' 
                        ? '<span class="badge bg-success">Done</span>' 
                        : '<span class="badge bg-warning text-dark">New</span>';
                    
                    const reqIcon = p.review_requested ? '<span title="Patient requested review">‚úã</span>' : '';
                    const reqBadge = p.review_requested && p.doc_status !== 'reviewed' ? '<span class="badge bg-danger ms-1">Req</span>' : '';

                    const html = `
                        <div class="patient-card ${severityClass}" onclick="loadReport(${p.id})">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="fw-bold m-0 text-dark">${p.name} ${reqIcon}</h6>
                                <div>${statusBadge} ${reqBadge}</div>
                            </div>
                            <small class="text-muted d-block mt-1">
                                ${p.age} yrs ‚Ä¢ ${p.gender}
                            </small>
                            <small class="text-muted" style="font-size: 11px;">ID: #${p.id}</small>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            });
    }

    // --- 2. LOAD SPECIFIC REPORT ---
    function loadReport(id) {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

       fetch(`../api/dashboard_doc.php?action=get_report&id=${id}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('pName').innerText = data.name;
                document.getElementById('pDetails').innerText = `ID: #${data.patient_id} | Age: ${data.age}`;
                
                document.getElementById('scanImg').src = `../uploads/${data.image}`;
                document.getElementById('imgLink').href = `../uploads/${data.image}`;
                
                document.getElementById('aiResult').innerText = data.ai_result || "No AI analysis available.";
                
                document.getElementById('reportId').value = data.id;
                document.getElementById('docOpinion').value = data.doctor_opinion || "";
                
                document.getElementById('dietLink').href = `diet.html?id=${data.id}`;
            });
    }

    // --- 3. SAVE DIAGNOSIS ---
    document.getElementById('diagnosisForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('../api/dashboard_doc.php',  {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                alert("‚úÖ Diagnosis Saved Successfully!");
                loadPatients(); // Refresh sidebar to show "Done" status
            } else {
                alert("‚ùå Error saving: " + data.error);
            }
        });
    });
</script>

</body>
</html>